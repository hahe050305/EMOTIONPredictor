<!DOCTYPE html>
<html>
<head>
  <title>Clinical AI Validator</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    #app-container { width: 100%; max-width: 600px; text-align: center; }
    #video-wrapper { position: relative; border-radius: 12px; overflow: hidden; background: #000; line-height: 0; }
    video { width: 100%; height: auto; transform: scaleX(-1); }
    .hidden { display: none !important; }
    
    /* Stats Bar */
    #live-stats { display: flex; justify-content: space-around; background: var(--card); padding: 15px; border-radius: 0 0 12px 12px; border: 1px solid #334155; }
    .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--accent); display: block; }
    .label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }

    /* Buttons */
    .controls { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    #btn-start { background: var(--accent); color: #0f172a; width: 100%; font-size: 1.1rem; }
    .btn-stop { background: #ef4444; color: white; }
    
    /* Feedback Section */
    #feedback-panel { background: var(--card); padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid #334155; }
    
    /* Report Section */
    #report-view { background: var(--card); padding: 25px; border-radius: 16px; text-align: left; width: 100%; }
    .clinical-note { background: #0f172a; padding: 15px; border-left: 4px solid var(--accent); margin-top: 15px; font-style: italic; }
  </style>
</head>
<body>

<div id="app-container">
  <div id="setup-view">
    <h2 style="color: var(--accent)">Mental Health AI Pro</h2>
    <p>This tool analyzes mood, attention, and blinks in real-time.</p>
    <button id="btn-start" class="btn" onclick="startApp()">ENABLE WEBCAM & START</button>
  </div>

  <div id="test-view" class="hidden">
    <div id="video-wrapper">
      <video id="webcam" autoplay playsinline></video>
    </div>
    <div id="live-stats">
      <div><span class="label">Mood</span><span id="mood" class="stat-val">---</span></div>
      <div><span class="label">Blinks</span><span id="blinks" class="stat-val">0</span></div>
      <div><span class="label">Focus</span><span id="attn" class="stat-val">---</span></div>
    </div>

    <div id="feedback-panel">
      <p style="margin-top:0">Is AI Correct?</p>
      <input type="radio" name="acc" id="ry" value="yes"> <label for="ry">Yes ✅</label> &nbsp;&nbsp;
      <input type="radio" name="acc" id="rn" value="no"> <label for="rn">No ❌</label>
    </div>

    <div class="controls">
      <button class="btn btn-stop" onclick="stopAnalysis()">FINISH & VIEW REPORT</button>
    </div>
  </div>

  <div id="report-view" class="hidden">
    <h2 style="color:var(--accent)">Session Analytics</h2>
    <canvas id="moodChart"></canvas>
    <div class="clinical-note">
      <strong>Diagnostic Summary:</strong><br>
      <span id="summary-text">Generating...</span>
    </div>
    <p id="accuracy-stat" style="color:#94a3b8; font-size: 0.9rem; margin-top:15px;"></p>
    <button class="btn" style="background:#334155; color:white; width:100%" onclick="location.reload()">RESTART TEST</button>
  </div>
</div>

<script type="module">
  import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

  const SCRIPT_URL = "YOUR_GOOGLE_SCRIPT_URL_HERE"; // PASTE YOUR URL HERE
  const video = document.getElementById('webcam');
  let faceLandmarker, blinks = 0, blinkActive = false, isRunning = true;
  let sessionMoods = [], feedback = {yes: 0, no: 0};
  let baselines = {}, calibrationFrames = [];

  // Manual Trigger for Mobile/Permissions
  window.startApp = async () => {
    document.getElementById('setup-view').classList.add('hidden');
    document.getElementById('test-view').classList.remove('hidden');
    
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;
      
      const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm");
      faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
        baseOptions: { 
          modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
          delegate: "GPU" 
        },
        outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1
      });

      video.addEventListener('loadeddata', predict);
    } catch (err) {
      alert("Webcam Error: " + err.message + "\nEnsure you granted permission.");
    }
  };

  async function predict() {
    if(!isRunning || !faceLandmarker) return;
    const result = faceLandmarker.detectForVideo(video, performance.now());

    if (result.faceBlendshapes?.[0]) {
      const s = {};
      result.faceBlendshapes[0].categories.forEach(c => s[c.categoryName] = c.score);

      // Calibration logic (10 frames)
      if (calibrationFrames.length < 10) {
        calibrationFrames.push(s);
        if(calibrationFrames.length === 10) {
          Object.keys(s).forEach(k => baselines[k] = calibrationFrames.reduce((a,b)=>a+b[k],0)/10);
        }
      } else {
        const getRel = (n) => Math.max(0, (s[n] || 0) - (baselines[n] || 0));
        const joy = getRel('mouthSmileLeft') * 1.6;
        const sad = (getRel('browInnerUp') + getRel('frownLeft')) * 1.1;
        
        let mood = (joy > sad && joy > 0.2) ? "Happy" : (sad > 0.25) ? "Sad" : "Normal";

        // High-Speed Blink Sync
        const eyeClose = Math.max(s['eyeBlinkLeft'], s['eyeBlinkRight']);
        if (eyeClose > 0.4 && !blinkActive) { blinks++; blinkActive = true; } 
        else if (eyeClose < 0.2) { blinkActive = false; }

        // Live Update
        document.getElementById('mood').innerText = mood;
        document.getElementById('blinks').innerText = blinks;
        document.getElementById('attn').innerText = s['eyeLookInLeft'] < 0.3 ? "Focused" : "Distracted";
        sessionMoods.push(mood);

        // Feedback Logic
        if(document.getElementById('ry').checked) { feedback.yes++; document.getElementById('ry').checked = false; }
        if(document.getElementById('rn').checked) { feedback.no++; document.getElementById('rn').checked = false; }
      }
    }
    requestAnimationFrame(predict);
  }

  window.stopAnalysis = () => {
    isRunning = false;
    document.getElementById('test-view').classList.add('hidden');
    document.getElementById('report-view').classList.remove('hidden');
    
    const counts = sessionMoods.reduce((a,b) => (a[b] = (a[b]||0)+1, a), {});
    const dominant = Object.keys(counts).reduce((a,b) => counts[a] > counts[b] ? a : b, "Normal");

    // Chart
    new Chart(document.getElementById('moodChart'), {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{ label: 'Mood Frequency', data: Object.values(counts), backgroundColor: '#38bdf8' }]
      }
    });

    const summary = dominant === "Sad" ? "High levels of facial fatigue/sadness detected." : "Overall mood appears stable.";
    document.getElementById('summary-text').innerText = summary;
    
    // Log to Excel (Sheet)
    const totalF = feedback.yes + feedback.no;
    const accPercent = totalF > 0 ? Math.round((feedback.yes/totalF)*100) : "N/A";
    document.getElementById('accuracy-stat').innerText = `Self-Reported Accuracy: ${accPercent}%`;

    if(SCRIPT_URL !== "YOUR_GOOGLE_SCRIPT_URL_HERE") {
      fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({ mood: dominant, accuracy: accPercent + "%", blinks: blinks, attention: "Checked", note: summary })
      });
    }
  };
</script>
</body>
</html>
